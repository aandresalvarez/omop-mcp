{
  "sql": "WITH\n-- Ancestor lists provided\nheart_ancestor_ids AS (\n  SELECT 316139 AS concept_id UNION ALL SELECT 319835 UNION ALL SELECT 4229440\n),\nesrd_ancestor_ids AS (\n  SELECT 193782 AS concept_id UNION ALL SELECT 37018886 UNION ALL SELECT 43020455\n),\ndialysis_ancestor_ids AS (\n  SELECT 4120120 AS concept_id UNION ALL SELECT 46273700 UNION ALL SELECT 4050863\n),\ntransplant_ancestor_ids AS (\n  SELECT 4322471 AS concept_id UNION ALL SELECT 4021107\n),\n\n-- Expand to descendant standard concepts using concept_ancestor and concept (include descendants; standard only)\nheart_concepts AS (\n  SELECT DISTINCT c.concept_id\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept_ancestor` ca\n  JOIN `bigquery-public-data.cms_synthetic_patient_data_omop.concept` c\n    ON ca.descendant_concept_id = c.concept_id\n  WHERE ca.ancestor_concept_id IN (SELECT concept_id FROM heart_ancestor_ids)\n    AND c.standard_concept = 'S'\n  UNION DISTINCT\n  SELECT concept_id FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept`\n  WHERE concept_id IN (SELECT concept_id FROM heart_ancestor_ids) AND standard_concept = 'S'\n),\n\nesrd_concepts AS (\n  SELECT DISTINCT c.concept_id\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept_ancestor` ca\n  JOIN `bigquery-public-data.cms_synthetic_patient_data_omop.concept` c\n    ON ca.descendant_concept_id = c.concept_id\n  WHERE ca.ancestor_concept_id IN (SELECT concept_id FROM esrd_ancestor_ids)\n    AND c.standard_concept = 'S'\n  UNION DISTINCT\n  SELECT concept_id FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept`\n  WHERE concept_id IN (SELECT concept_id FROM esrd_ancestor_ids) AND standard_concept = 'S'\n),\n\ndialysis_concepts AS (\n  SELECT DISTINCT c.concept_id\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept_ancestor` ca\n  JOIN `bigquery-public-data.cms_synthetic_patient_data_omop.concept` c\n    ON ca.descendant_concept_id = c.concept_id\n  WHERE ca.ancestor_concept_id IN (SELECT concept_id FROM dialysis_ancestor_ids)\n    AND c.standard_concept = 'S'\n  UNION DISTINCT\n  SELECT concept_id FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept`\n  WHERE concept_id IN (SELECT concept_id FROM dialysis_ancestor_ids) AND standard_concept = 'S'\n),\n\ntransplant_concepts AS (\n  SELECT DISTINCT c.concept_id\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept_ancestor` ca\n  JOIN `bigquery-public-data.cms_synthetic_patient_data_omop.concept` c\n    ON ca.descendant_concept_id = c.concept_id\n  WHERE ca.ancestor_concept_id IN (SELECT concept_id FROM transplant_ancestor_ids)\n    AND c.standard_concept = 'S'\n  UNION DISTINCT\n  SELECT concept_id FROM `bigquery-public-data.cms_synthetic_patient_data_omop.concept`\n  WHERE concept_id IN (SELECT concept_id FROM transplant_ancestor_ids) AND standard_concept = 'S'\n),\n\n-- Condition occurrences for heart failure and ESRD\nheart_occurrences AS (\n  SELECT person_id, condition_start_date\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.condition_occurrence`\n  WHERE condition_concept_id IN (SELECT concept_id FROM heart_concepts)\n),\n\nesrd_occurrences AS (\n  SELECT person_id, condition_start_date\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.condition_occurrence`\n  WHERE condition_concept_id IN (SELECT concept_id FROM esrd_concepts)\n),\n\n-- Procedure occurrences for dialysis and transplant (captured but not required for cohort entry)\ndialysis_occurrences AS (\n  SELECT person_id, procedure_datetime AS procedure_date\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.procedure_occurrence`\n  WHERE procedure_concept_id IN (SELECT concept_id FROM dialysis_concepts)\n),\n\ntransplant_occurrences AS (\n  SELECT person_id, procedure_datetime AS procedure_date\n  FROM `bigquery-public-data.cms_synthetic_patient_data_omop.procedure_occurrence`\n  WHERE procedure_concept_id IN (SELECT concept_id FROM transplant_concepts)\n),\n\n-- ESRD occurrences that have at least one prior heart failure diagnosis (heart failure at any time before ESRD)\nesrd_after_prior_heart AS (\n  SELECT e.person_id, e.condition_start_date AS index_date\n  FROM esrd_occurrences e\n  WHERE EXISTS (\n    SELECT 1\n    FROM heart_occurrences h\n    WHERE h.person_id = e.person_id\n      AND h.condition_start_date < e.condition_start_date\n  )\n),\n\n-- For each person, take the first ESRD occurrence that occurs after an earlier heart failure diagnosis\nfirst_esrd_after_heart AS (\n  SELECT person_id, index_date,\n    ROW_NUMBER() OVER (PARTITION BY person_id ORDER BY index_date) AS rn\n  FROM esrd_after_prior_heart\n)\n\n-- Final cohort: persons with the first ESRD after prior heart failure; include only persons present in person table (use pre-extracted demographics)\nSELECT p.person_id, fe.index_date AS cohort_entry_date\nFROM first_esrd_after_heart fe\nJOIN `bigquery-public-data.cms_synthetic_patient_data_omop.person` p\n  ON p.person_id = fe.person_id\nWHERE fe.rn = 1;",
  "is_valid": true,
  "errors": [],
  "estimated_cost_usd": 0.04041588695599785,
  "total_bytes_processed": 8887547531,
  "summary": "\u2705 SQL is valid. Estimated to process 8.28 GB (\u2248$0.0404)"
}
